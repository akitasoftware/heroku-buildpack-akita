#!/usr/bin/env bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BUILDPACK_DIR=$(cd "$(dirname "${BUILD_DIR}")"; cd ..; pwd)

# TODO(kku): store apt cache in CACHE_DIR

echo "Installing Akita CLI"

apt-get update
apt-get install -y apt-transport-https curl gnupg

sh -c "echo 'deb [arch=amd64] https://apt.releases.akita.software/ stable main' > /etc/apt/sources.list.d/akita.list"
curl -f https://releases.akita.software/keys/akita-apt.public | apt-key add -
apt-get update \
  -o Dir::Etc::sourcelist="sources.list.d/akita.list" \
  -o Dir::Etc::sourceparts="-" \
  -o APT::Get::List-Cleanup="0"

apt-get install -y --force-yes akita-cli

# Add to .profile.d to automatically run at startup.
echo "Setting up Akita CLI in .profile.d"

mkdir -p "${BUILD_DIR}/.profile.d"
cp "$BUILDPACK_DIR/.profile.d/akita.sh" "$BUILD_DIR/.profile.d/akita.sh"
chmod +x "${BUILD_DIR}/.profile.d/akita.sh"
